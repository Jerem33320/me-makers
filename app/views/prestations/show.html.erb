<div class="container">
  <h1 class="top-title">Votre devis</h1>
  <div class="text-center">
    <h6>avec</h6>
    <% if current_user.artisan %>
      <h5><%= @prestation.project.user.first_name %> <%= @prestation.project.user.last_name %></h5>
    <% else %>
      <h5><%= @prestation.artisan.first_name %> <%= @prestation.artisan.last_name %></h5>
      <h6><%= @prestation.artisan.specialty.capitalize %></h6>
    <% end %>
    <br>
    <h6><strong>Titre</strong></h6>
    <p>
      <%= @prestation.title %>
    </p>
    <h6><strong>Description</strong></h6>
    <p>
      <%= @prestation.description %>
    </p>
    <h6><strong>Date</strong></h6>
    <p>
      à partir du <%= @prestation.project.date.day %>/<%= @prestation.project.date.month %>/<%= @prestation.project.date.year %>
    </p>
    <h6><strong>Matériaux</strong></h6>
    <p>
      <%= @prestation.material %>
    </p>
    <h6><strong>Main d'oeuvre</strong></h6>
    <p>
      <%= @prestation.workforce %>
    </p>
    <h6><strong>Prix</strong></h6>
    <p>
      <%= @prestation.price %> €
    </p>
    <br>
    <% if current_user.artisan %>
      <p>
        <%= link_to "Editer le devis", edit_me_artisans_prestation_path(@prestation), class: 'btn btn-light' %>
        <%= link_to "Retour", me_artisans_prestations_path, class: 'btn btn-light' %>
    <% else %>
        <%= link_to "Valider", '#', class: 'btn btn-light' %>
        <%= link_to "Rejeter", '#', class: 'btn btn-light' %>
        <%= link_to "Retour", projects_path, class: 'btn btn-light' %>
      </p>
    <% end %>
  </div>

  <!-- Chat-room -->
  <div class="row">
    <div class="col-sm-12">
      <div class="chat-header"><h4>Messagerie</h4></div>
      <div class="messages">
        <% @prestation.messages.each do |message| %>
          <%= render "messages/message", message: message, user_is_messages_author: message.user == current_user %>
        <% end %>
      </div>
      <div class="create-message">
        <%= simple_form_for [@prestation, Message.new ], remote: true do |f| %>
          <%= f.input :content, label: false %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% content_for :after_js do %>
  <script>
    App['prestation_<%= @prestation.id %>'] = App.cable.subscriptions.create(
      { channel: 'PrestationsChannel', prestation_id: <%= @prestation.id %> }, {
      connected: () => {
        console.log("[CONNECTED]")
      },
      received: (data) => {
        const messagesContainer = document.querySelector('.messages');
        messagesContainer.insertAdjacentHTML('beforeend', data.message_partial);
        if (data.author_id == <%= current_user.id %>) {
          document.getElementById(data.message_id).classList.add("right")
        }
        const input = document.querySelector('#message_content');
        input.value = '';
        }
      }
    )
  </script>
<% end %>
